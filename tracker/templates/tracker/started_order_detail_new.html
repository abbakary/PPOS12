{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}

{% block title %}Order {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-md-8">
        <h4>
          <i class="fa fa-play me-2"></i>Order {{ order.order_number }}
          {% if vehicle %}
            <small class="text-muted ms-2"><i class="fa fa-car"></i> {{ vehicle.plate_number }}</small>
          {% endif %}
        </h4>
      </div>
      <div class="col-md-4">
        <ol class="breadcrumb justify-content-end">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item"><a href="{% url 'tracker:started_orders_dashboard' %}">Started Orders</a></li>
          <li class="breadcrumb-item active">{{ order.order_number }}</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-left border-4" style="border-left-color: #667eea;">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col-md-6">
              <p class="mb-2"><strong>Status:</strong> <span class="badge bg-secondary">New</span></p>
              <p class="mb-0"><strong>Started:</strong> <span class="text-muted">{{ order.started_at|date:"M d, Y H:i" }}</span></p>
            </div>
            <div class="col-md-6 text-md-end">
              <p class="mb-2"><strong>Type:</strong> 
                {% if order.type == 'service' %}
                  <span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span>
                {% elif order.type == 'sales' %}
                  <span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span>
                {% else %}
                  <span class="badge bg-secondary">{{ order.type }}</span>
                {% endif %}
              </p>
              <p class="mb-0"><strong>Progress:</strong> <span class="text-muted">Step 1 of 3</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Action Buttons -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-3 justify-content-center">
            <!-- Customer and Vehicle Info -->
            <div class="btn-group" role="group">
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('customer')">
                <i class="fa fa-user me-2"></i>Customer Info
              </button>
              {% if vehicle %}
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('vehicle')">
                <i class="fa fa-car me-2"></i>Vehicle Info
              </button>
              {% endif %}
            </div>

            <!-- Order Management -->
            <div class="btn-group" role="group">
              <button type="button" id="uploadInvoiceBtn" class="btn btn-primary">
                <i class="fa fa-file-upload me-2"></i>Upload Invoice
              </button>
              <button type="button" id="editOrderDetailsBtn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editOrderDetailsModal">
                <i class="fa fa-list me-2"></i>Edit Details
              </button>
            </div>

            <!-- Complete Order -->
            <button type="button" id="completeOrderBtn" class="btn btn-success">
              <i class="fa fa-check me-2"></i>Complete Order
            </button>
          </div>

          <!-- Overrun Reason Modal -->
          <div class="modal fade" id="overrunReasonModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                  <h5 class="modal-title">Order Overrun Reason</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p class="mb-2">This service order has exceeded the expected time. Please provide a reason before completing.</p>
                  <div class="mb-3">
                    <label class="form-label">Reason</label>
                    <textarea id="overrunReasonInput" class="form-control" rows="4" placeholder="Explain why this order exceeded its ETA (required)"></textarea>
                    <div id="overrunReasonError" class="text-danger mt-2" style="display:none;"></div>
                  </div>
                </div>
                <div class="modal-footer bg-light">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" id="saveOverrunReasonBtn" class="btn btn-warning">Save & Continue to Complete</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Combined Invoice Modal (Upload & Editable Form) -->
          <div class="modal fade" id="uploadInvoiceModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header bg-light border-bottom">
                  <h5 class="modal-title">
                    <i class="fa fa-file-invoice me-2"></i>Create Invoice for Order {{ order.order_number }}
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <form id="manualInvoiceForm" method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="create_invoice_manual">
                  <input type="hidden" name="selected_order_id" value="{{ order.id }}">
                  {% if vehicle and vehicle.plate_number %}<input type="hidden" name="plate" value="{{ vehicle.plate_number }}">{% endif %}
                  
                  <!-- Hidden fields for additional details -->
                  <input type="hidden" name="payment_method" id="hiddenPaymentMethod" value="">
                  <input type="hidden" name="delivery_terms" id="hiddenDeliveryTerms" value="">
                  <input type="hidden" name="attended_by" id="hiddenAttendedBy" value="">
                  <input type="hidden" name="kind_attention" id="hiddenKindAttention" value="">
                  <input type="hidden" name="remarks" id="hiddenRemarks" value="">
                  <input type="hidden" name="notes" id="hiddenNotes" value="">

                  <!-- Quick Info Bar -->
                  <div class="alert alert-info mb-3 border-0" role="alert">
                    <div class="d-flex align-items-center">
                      <i class="fa fa-lightbulb me-3" style="font-size: 18px;"></i>
                      <div>
                        <strong>Tip:</strong> Upload a PDF invoice to auto-extract data, or fill in the form manually. All fields are editable.
                      </div>
                    </div>
                  </div>

                  <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Upload Section -->
                    <div class="card mb-3">
                      <div class="card-header bg-light">
                        <strong><i class="fa fa-file-upload me-2"></i>Upload PDF (Optional)</strong>
                      </div>
                      <div class="card-body">
                        <div class="mb-3">
                          <label class="form-label">Select PDF File</label>
                          <input type="file" id="startedOrderInvoiceFile" class="form-control" accept=".pdf" data-max-file-size="50485760">
                          <small class="text-muted">PDF files only. Max 50MB. Leave empty to enter data manually.</small>
                        </div>

                        <div id="startedUploadError" class="alert alert-danger" style="display:none" role="alert"></div>
                        <div id="extractionSuccess" class="alert alert-success" style="display:none" role="alert">
                          <i class="fa fa-check-circle me-2"></i>Data extracted successfully! The form below has been auto-populated.
                        </div>
                        <div id="startedUploadProgress" class="progress" style="display:none;">
                          <div class="progress-bar progress-bar-striped progress-bar-animated" id="startedUploadProgressBar" role="progressbar" style="width: 0%"></div>
                        </div>

                        <button type="button" id="startedUploadBtn" class="btn btn-primary">
                          <i class="fa fa-upload me-2"></i>Upload & Extract
                        </button>
                      </div>
                    </div>

                    <!-- Extracted Data Preview -->
                    <div id="uploadedInvoicePreview" style="display:none;" class="card mb-3">
                      <div class="card-header bg-light">
                        <strong><i class="fa fa-check-circle me-2 text-success"></i>Extracted Data Preview</strong>
                        <small class="text-muted ms-2">Edit the fields below as needed</small>
                      </div>
                      <div class="card-body" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                        <div class="row g-2">
                          <div class="col-md-6">
                            <small class="text-muted d-block">Customer Name</small>
                            <p id="previewCustomerName" class="mb-2">-</p>
                          </div>
                          <div class="col-md-6">
                            <small class="text-muted d-block">Phone</small>
                            <p id="previewCustomerPhone" class="mb-2">-</p>
                          </div>
                          <div class="col-md-6">
                            <small class="text-muted d-block">Email</small>
                            <p id="previewCustomerEmail" class="mb-2">-</p>
                          </div>
                          <div class="col-md-6">
                            <small class="text-muted d-block">Address</small>
                            <p id="previewCustomerAddress" class="mb-2">-</p>
                          </div>
                          <div class="col-md-6">
                            <small class="text-muted d-block">Invoice Number</small>
                            <p id="previewInvoiceNo" class="mb-2"><strong>-</strong></p>
                          </div>
                          <div class="col-md-6">
                            <small class="text-muted d-block">Invoice Date</small>
                            <p id="previewInvoiceDate" class="mb-2"><strong>-</strong></p>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Subtotal</small>
                            <p id="previewSubtotal" class="mb-0">-</p>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Tax/VAT</small>
                            <p id="previewTax" class="mb-0">-</p>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Total</small>
                            <p id="previewTotal" class="mb-0 fs-6"><strong>-</strong></p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Existing Customer Alert -->
                    <div id="existingCustomerAlert" class="alert alert-info alert-dismissible fade show mb-3" style="display:none;">
                      <i class="fa fa-info-circle me-2"></i>
                      <strong>Existing Customer Found!</strong> A customer with this phone number already exists.
                      <span id="existingCustomerName"></span>
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <!-- Customer Information Section -->
                    <div class="card mb-3">
                      <div class="card-header bg-light">
                        <strong><i class="fa fa-user me-2"></i>Customer Information</strong>
                      </div>
                      <div class="card-body">
                        <div class="row mb-2">
                          <div class="col-md-6">
                            <label class="form-label">Full Name *</label>
                            <input type="text" name="customer_name" class="form-control" id="manualCustomerName" value="{{ order.customer.full_name }}" placeholder="Customer full name" required>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Phone <small class="text-muted">(optional)</small></label>
                            <input type="tel" name="customer_phone" class="form-control" id="manualCustomerPhone" placeholder="Phone number">
                          </div>
                        </div>
                        <div class="row mb-2">
                          <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="customer_email" class="form-control" placeholder="email@example.com">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Customer Type *</label>
                            <select name="customer_type" id="invoiceCustomerType" class="form-select" required>
                              <option value="">Select customer type</option>
                              <option value="personal">Personal</option>
                              <option value="company">Private Company</option>
                              <option value="ngo">NGO</option>
                              <option value="government">Government</option>
                            </select>
                          </div>
                        </div>
                        
                        <!-- Personal Subtype (shown only for personal type) -->
                        <div class="row mb-2" id="personalSubtypeWrapper" style="display:none;">
                          <div class="col-md-6">
                            <label class="form-label">Personal Subtype</label>
                            <select name="customer_personal_subtype" class="form-select">
                              <option value="">Select subtype</option>
                              <option value="owner">Owner</option>
                              <option value="driver">Driver</option>
                            </select>
                          </div>
                        </div>

                        <!-- Organization Fields (shown for non-personal types) -->
                        <div class="row mb-2" id="organizationDetailsWrapper" style="display:none;">
                          <div class="col-md-6">
                            <label class="form-label">Organization Name</label>
                            <input type="text" name="customer_organization_name" class="form-control" id="organizationNameField" placeholder="Organization name">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Tax Number</label>
                            <input type="text" name="customer_tax_number" class="form-control" id="taxNumberField" placeholder="Tax identification number">
                          </div>
                        </div>

                        <div class="row mb-2">
                          <div class="col-md-12">
                            <label class="form-label">Address</label>
                            <input type="text" name="customer_address" class="form-control" placeholder="Customer address">
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Invoice Information Section -->
                    <div class="card mb-3">
                      <div class="card-header bg-light">
                        <strong><i class="fa fa-file-invoice me-2"></i>Invoice Information</strong>
                      </div>
                      <div class="card-body">
                        <div class="row mb-2">
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Invoice Number</label>
                            <input type="text" name="invoice_number" class="form-control" placeholder="e.g., INV-001">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Invoice Date</label>
                            <input type="date" name="invoice_date" class="form-control" value="{% now 'Y-m-d' %}" required>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Payment Information Section -->
                    <div class="card mb-3">
                      <div class="card-header bg-light">
                        <strong><i class="fa fa-money me-2"></i>Payment Information</strong>
                      </div>
                      <div class="card-body">
                        <div class="row mb-2">
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Subtotal</label>
                            <div class="input-group">
                              <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                              <input type="number" name="subtotal" class="form-control" step="0.01" min="0" placeholder="0.00">
                            </div>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Tax/VAT</label>
                            <div class="input-group">
                              <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                              <input type="number" name="tax_amount" class="form-control" step="0.01" min="0" placeholder="0.00">
                            </div>
                          </div>
                        </div>

                        <div class="row mb-2">
                          <div class="col-md-12">
                            <label class="form-label fw-bold">Total Amount *</label>
                            <div class="input-group">
                              <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                              <input type="number" name="total_amount" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 20px; background: #f8f9fa;">
                    <div class="text-center w-100 mb-3">
                      <p class="text-muted small mb-0">
                        <i class="fa fa-info-circle me-1"></i>
                        Fill in the required fields (marked with *), then click the button below to create the invoice.
                      </p>
                    </div>
                    <div class="w-100 d-flex gap-2" style="margin-top: -15px;">
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fa fa-times me-2"></i>Cancel
                      </button>
                      <button type="submit" class="btn btn-success btn-lg flex-grow-1" style="font-weight: 600;">
                        <i class="fa fa-check-circle me-2"></i>Create Invoice
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Edit Order Details Modal -->
          <div class="modal fade" id="editOrderDetailsModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fa fa-list me-2"></i>Edit Order Details</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="orderDetailsForm" method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="update_order_details">
                  <div class="modal-body">
                    <!-- Item Selection for Sales Orders -->
                    <div id="itemSelectionSection" class="mb-3" style="display:none;">
                      <label class="form-label fw-bold">Select Item</label>
                      <select id="editOrderItemSelect" name="item_id" class="form-select mb-2">
                        <option value="">Loading items...</option>
                      </select>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <label class="form-label">Brand</label>
                          <input type="text" id="editOrderBrand" name="item_brand" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Quantity</label>
                          <input type="number" id="editOrderQuantity" name="item_quantity" class="form-control" value="1" min="1">
                        </div>
                      </div>
                    </div>

                    <!-- Duration -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">Estimated Duration (minutes)</label>
                      <input type="number" name="estimated_duration" id="orderEstimatedDuration" class="form-control" value="{{ order.estimated_duration|default:'' }}" min="0">
                    </div>
                    <div class="mb-2 text-muted small" id="editOrderHelpText">Update the order details as needed.</div>
                  </div>
                  <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <script>
            // Safe querySelectorAll function with null check
            function safeQuerySelectorAll(selector, context) {
              const element = context ? context.querySelectorAll(selector) : document.querySelectorAll(selector);
              return element || [];
            }

            // Customer type visibility toggle
            const customerTypeEl = document.getElementById('invoiceCustomerType');
            const personalSubtypeWrapper = document.getElementById('personalSubtypeWrapper');
            const organizationDetailsWrapper = document.getElementById('organizationDetailsWrapper');

            if (customerTypeEl) {
              function updateCustomerTypeFields() {
                const selectedType = customerTypeEl.value;
                
                if (selectedType === 'personal') {
                  if (personalSubtypeWrapper) personalSubtypeWrapper.style.display = 'block';
                  if (organizationDetailsWrapper) organizationDetailsWrapper.style.display = 'none';
                } else if (selectedType && ['company', 'ngo', 'government'].includes(selectedType)) {
                  if (personalSubtypeWrapper) personalSubtypeWrapper.style.display = 'none';
                  if (organizationDetailsWrapper) organizationDetailsWrapper.style.display = 'block';
                } else {
                  if (personalSubtypeWrapper) personalSubtypeWrapper.style.display = 'none';
                  if (organizationDetailsWrapper) organizationDetailsWrapper.style.display = 'none';
                }
              }

              customerTypeEl.addEventListener('change', updateCustomerTypeFields);
              updateCustomerTypeFields();
            }

            // Modal and form handling
            document.addEventListener('DOMContentLoaded', function(){
              const uploadBtn = document.getElementById('uploadInvoiceBtn');
              const modalEl = document.getElementById('uploadInvoiceModal');
              const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

              // Upload elements
              const fileInput = document.getElementById('startedOrderInvoiceFile');
              const startedUploadBtn = document.getElementById('startedUploadBtn');
              const startedUploadError = document.getElementById('startedUploadError');
              const extractionSuccess = document.getElementById('extractionSuccess');
              const uploadProgress = document.getElementById('startedUploadProgress');
              const uploadProgressBar = document.getElementById('startedUploadProgressBar');
              const uploadedInvoicePreview = document.getElementById('uploadedInvoicePreview');

              // Manual form elements
              const manualForm = document.getElementById('manualInvoiceForm');
              const manualCustomerPhone = document.getElementById('manualCustomerPhone');
              const existingCustomerAlert = document.getElementById('existingCustomerAlert');
              const existingCustomerName = document.getElementById('existingCustomerName');

              let extractedInvoiceData = null;

              function getCSRF() {
                return getCSRFToken() || '';
              }

              function showError(message, isDanger = true) {
                if (startedUploadError) {
                  startedUploadError.style.display = 'block';
                  startedUploadError.innerHTML = message;
                  startedUploadError.className = isDanger ? 'alert alert-danger' : 'alert alert-warning';
                }
                if (extractionSuccess) extractionSuccess.style.display = 'none';
              }

              function showSuccess(message) {
                if (extractionSuccess) {
                  extractionSuccess.style.display = 'block';
                  extractionSuccess.innerHTML = message;
                }
                if (startedUploadError) startedUploadError.style.display = 'none';
              }

              function resetForm() {
                if (fileInput) fileInput.value = '';
                if (startedUploadError) startedUploadError.style.display = 'none';
                if (extractionSuccess) extractionSuccess.style.display = 'none';
                if (uploadProgress) uploadProgress.style.display = 'none';
                if (uploadedInvoicePreview) uploadedInvoicePreview.style.display = 'none';
                extractedInvoiceData = null;
              }

              function escapeHtml(text) {
                if (!text) return '';
                const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
              }

              function cleanCustomerName(customerName) {
                if (!customerName) return '';
                let cleaned = customerName.trim();
                const patterns = [
                  /^customer\s*name\s*[:]?\s*/i,
                  /^customer\s*[:]?\s*/i,
                  /^name\s*[:]?\s*/i,
                  /\s*customer\s*name\s*$/i,
                  /\s*customer\s*$/i
                ];
                patterns.forEach(pattern => {
                  cleaned = cleaned.replace(pattern, '');
                });
                return cleaned.replace(/^[:]\s*/, '').replace(/\s*[:]$/, '').replace(/\s+/g, ' ').trim();
              }

              function cleanExtractedHeader(header) {
                if (!header) return {};
                const cleanedHeader = {...header};
                if (cleanedHeader.customer_name) cleanedHeader.customer_name = cleanCustomerName(cleanedHeader.customer_name);
                if (cleanedHeader.phone) cleanedHeader.phone = cleanedHeader.phone.replace(/^(phone|tel|telephone|mobile|cell)[\s:]*/i, '').trim();
                if (cleanedHeader.email) cleanedHeader.email = cleanedHeader.email.replace(/^(email|e-mail|mail)[\s:]*/i, '').trim();
                if (cleanedHeader.address) cleanedHeader.address = cleanedHeader.address.replace(/^(address|location|addr)[\s:]*/i, '').trim();
                if (cleanedHeader.invoice_no) cleanedHeader.invoice_no = cleanedHeader.invoice_no.replace(/^(invoice\s*(no|number|#)?[\s:]*)/i, '').trim();
                return cleanedHeader;
              }

              function checkExistingCustomer(phone) {
                if (!phone || phone.length < 5) {
                  if (existingCustomerAlert) existingCustomerAlert.style.display = 'none';
                  return;
                }
                fetch('/api/customers/check-exists/?phone=' + encodeURIComponent(phone), {
                  headers: {'X-Requested-With': 'XMLHttpRequest'}
                })
                .then(r => r.json())
                .then(data => {
                  if (data.exists && data.customer) {
                    if (existingCustomerAlert && existingCustomerName) {
                      existingCustomerAlert.style.display = 'block';
                      existingCustomerName.innerHTML = '<strong>' + escapeHtml(data.customer.full_name) + '</strong>';
                    }
                  } else {
                    if (existingCustomerAlert) existingCustomerAlert.style.display = 'none';
                  }
                })
                .catch(err => {
                  console.debug('Error checking customer existence:', err);
                });
              }

              if (manualCustomerPhone) {
                manualCustomerPhone.addEventListener('change', function() {
                  checkExistingCustomer(this.value);
                });
              }

              if (uploadBtn) {
                uploadBtn.addEventListener('click', function() {
                  resetForm();
                  if (modal) modal.show();
                });
              }

              if (startedUploadBtn) {
                startedUploadBtn.addEventListener('click', async function() {
                  if (startedUploadError) startedUploadError.style.display = 'none';
                  if (extractionSuccess) extractionSuccess.style.display = 'none';

                  if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                    showError('<i class="fa fa-warning me-2"></i>Please select a PDF file to upload.');
                    return;
                  }

                  const file = fileInput.files[0];
                  const maxSizeMB = 50;
                  const maxSizeBytes = maxSizeMB * 1024 * 1024;

                  if (file.size > maxSizeBytes) {
                    showError(`<i class="fa fa-warning me-2"></i>File is too large. Maximum size is ${maxSizeMB}MB.`);
                    return;
                  }

                  if (!file.name.toLowerCase().endsWith('.pdf')) {
                    showError('<i class="fa fa-warning me-2"></i>Please upload a PDF file.', false);
                    return;
                  }

                  const fd = new FormData();
                  fd.append('file', file);
                  fd.append('selected_order_id', '{{ order.id }}');
                  {% if vehicle and vehicle.plate_number %}
                  fd.append('plate', '{{ vehicle.plate_number }}');
                  {% endif %}

                  startedUploadBtn.disabled = true;
                  if (uploadProgress) {
                    uploadProgress.style.display = 'block';
                    if (uploadProgressBar) uploadProgressBar.style.width = '50%';
                  }
                  const originalBtnText = startedUploadBtn.innerHTML;
                  startedUploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Extracting...';

                  try {
                    const extractResponse = await fetch('{% url "tracker:api_extract_invoice_preview" %}', {
                      method: 'POST',
                      body: fd,
                      headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRF()
                      },
                      credentials: 'same-origin'
                    });

                    if (uploadProgressBar) uploadProgressBar.style.width = '100%';
                    const extractData = await extractResponse.json();

                    if (!extractData.success) {
                      if (uploadProgress) uploadProgress.style.display = 'none';
                      const errorMsg = extractData.message || 'Could not extract data from PDF.';
                      showError(`<i class="fa fa-warning me-2"></i><strong>PDF could not be processed</strong><p class="small mt-2 mb-0">${errorMsg}</p>`, false);
                      return;
                    }

                    if (extractData.header) {
                      extractData.header = cleanExtractedHeader(extractData.header);
                    }

                    extractedInvoiceData = extractData;
                    populateManualFormWithExtracted(extractData);
                    showExtractedDataPreview(extractData.header, extractData.items);
                    if (uploadProgress) uploadProgress.style.display = 'none';
                    if (uploadProgressBar) uploadProgressBar.style.width = '0%';

                    showSuccess('Invoice data extracted successfully! The form below has been auto-populated with editable fields.');
                    if (uploadedInvoicePreview) uploadedInvoicePreview.style.display = 'block';

                  } catch (err) {
                    console.error('Upload error:', err);
                    if (uploadProgress) uploadProgress.style.display = 'none';
                    showError(`<i class="fa fa-exclamation-circle me-2"></i>Upload error: ${err && err.message ? err.message : 'Unknown error'}`);
                  } finally {
                    startedUploadBtn.disabled = false;
                    startedUploadBtn.innerHTML = originalBtnText;
                  }
                });
              }

              function showExtractedDataPreview(header, items) {
                const elements = {
                  'previewCustomerName': header.customer_name || '-',
                  'previewCustomerPhone': header.phone || '-',
                  'previewCustomerEmail': header.email || '-',
                  'previewCustomerAddress': header.address || '-',
                  'previewInvoiceNo': header.invoice_no || '-',
                  'previewInvoiceDate': header.date || '-',
                  'previewSubtotal': (header.subtotal || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                  'previewTax': (header.tax || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                  'previewTotal': (header.total || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                };

                Object.keys(elements).forEach(id => {
                  const el = document.getElementById(id);
                  if (el) el.textContent = elements[id];
                });

                if (uploadedInvoicePreview) uploadedInvoicePreview.style.display = 'block';
              }

              function populateManualFormWithExtracted(data) {
                const header = data.header || {};
                
                if (manualForm) {
                  const fields = {
                    'customer_name': header.customer_name,
                    'customer_phone': header.phone,
                    'customer_email': header.email,
                    'customer_address': header.address,
                    'invoice_number': header.invoice_no || header.code_no,
                    'subtotal': header.subtotal,
                    'tax_amount': header.tax,
                    'total_amount': header.total
                  };

                  Object.keys(fields).forEach(name => {
                    const input = manualForm.querySelector(`input[name="${name}"]`);
                    if (input && fields[name]) input.value = fields[name];
                  });

                  const customerTypeField = manualForm.querySelector('select[name="customer_type"]');
                  if (customerTypeField && header.customer_type) {
                    customerTypeField.value = header.customer_type;
                    customerTypeField.dispatchEvent(new Event('change'));
                  }

                  if (header.date) {
                    const dateMatch = String(header.date).match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    const invoiceDateField = manualForm.querySelector('input[name="invoice_date"]');
                    if (invoiceDateField && dateMatch) {
                      invoiceDateField.value = dateMatch[3] + '-' + String(dateMatch[2]).padStart(2, '0') + '-' + String(dateMatch[1]).padStart(2, '0');
                    }
                  }
                }
              }

              if (manualForm) {
                manualForm.addEventListener('submit', async function(e) {
                  e.preventDefault();

                  const customerName = this.querySelector('input[name="customer_name"]');
                  const customerType = this.querySelector('select[name="customer_type"]');
                  const totalAmount = this.querySelector('input[name="total_amount"]');

                  if (!customerName || !customerName.value.trim() ||
                      !customerType || !customerType.value.trim() ||
                      !totalAmount || !totalAmount.value.trim()) {
                    showError('<i class="fa fa-warning me-2"></i>Please fill in customer name, customer type, and total amount.');
                    return;
                  }

                  const fd = new FormData(this);
                  if (typeof fileInput !== 'undefined' && fileInput && fileInput.files && fileInput.files[0]) {
                    fd.append('file', fileInput.files[0]);
                  }

                  const submitBtn = this.querySelector('button[type="submit"]');
                  const originalBtnText = submitBtn.innerHTML;
                  submitBtn.disabled = true;
                  if (uploadProgress) {
                    uploadProgress.style.display = 'block';
                    if (uploadProgressBar) uploadProgressBar.style.width = '50%';
                  }

                  try {
                    const response = await fetch('{% url "tracker:api_create_invoice_from_upload" %}', {
                      method: 'POST',
                      body: fd,
                      headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRF()
                      }
                    });

                    if (uploadProgressBar) uploadProgressBar.style.width = '100%';
                    const result = await response.json();

                    if (result.success) {
                      showSuccess('<i class="fa fa-check-circle me-2"></i>Invoice created successfully! Redirecting...');
                      setTimeout(function() {
                        window.location.href = result.redirect_url || ('/tracker/invoices/' + result.invoice_id + '/');
                      }, 1000);
                    } else {
                      showError(`<i class="fa fa-exclamation-circle me-2"></i>${result.message || 'Failed to create invoice'}`);
                      if (uploadProgress) uploadProgress.style.display = 'none';
                      if (uploadProgressBar) uploadProgressBar.style.width = '0%';
                    }
                  } catch (err) {
                    console.error('Form submission error:', err);
                    showError(`<i class="fa fa-exclamation-circle me-2"></i>Error: ${err.message}`);
                    if (uploadProgress) uploadProgress.style.display = 'none';
                    if (uploadProgressBar) uploadProgressBar.style.width = '0%';
                  } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                  }
                });
              }

              if (modalEl) {
                modalEl.addEventListener('hidden.bs.modal', function() {
                  resetForm();
                });
              }
            });
          </script>
        </div>
      </div>
    </div>
  </div>

  <!-- Remaining page content (to be continued) -->
</div>
{% endblock %}
